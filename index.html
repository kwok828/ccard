<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>图片集</title>
  <style>
    :root { --bg:#0b0c10; --fg:#e8e8e8; --muted:#9aa0a6; --accent:#4da3ff; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}

    .wrap{display:flex;flex-direction:column;height:100%}
    header{padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header .title{font-weight:600;letter-spacing:.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    header .meta{font-size:12px;color:var(--muted)}

    .stage{position:relative;flex:1;min-height:280px;user-select:none;touch-action:pan-y}
    .stage-inner{position:absolute;inset:0;display:grid;place-items:center}
    .layer{position:absolute;inset:0;display:grid;place-items:center;opacity:0;transition:opacity .38s ease}
    .layer.show{opacity:1}

    img.viewer{max-width:100%;max-height:100%;object-fit:contain;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);
      transform-origin: center center; transition: transform 0.2s ease;}
    
    .zoom-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 10;
    }
    
    .zoom-btn {
      pointer-events: auto;
      appearance: none;
      border: 0;
      background: rgba(0,0,0,.35);
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      cursor: pointer;
      backdrop-filter: saturate(120%) blur(4px);
      transition: transform .15s ease, background .2s ease;
      font-size: 18px;
      font-weight: bold;
    }
    
    .zoom-btn:hover {
      transform: scale(1.05);
      background: rgba(0,0,0,.5);
    }
    
    .zoom-btn:active {
      transform: scale(.97);
    }

    .controls{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;pointer-events:none}
    .btn{pointer-events:auto;appearance:none;border:0;background:rgba(0,0,0,.35);color:#fff;width:44px;height:44px;border-radius:999px;margin:0 10px;display:grid;place-items:center;cursor:pointer;backdrop-filter:saturate(120%) blur(4px);transition:transform .15s ease, background .2s ease;}
    .btn:hover{transform:scale(1.05);background:rgba(0,0,0,.5)}
    .btn:active{transform:scale(.97)}

    .dots{position:absolute;left:0;right:0;bottom:14px;display:flex;justify-content:center;gap:8px;pointer-events:none}
    .dot{pointer-events:auto;width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35);outline:1px solid rgba(255,255,255,.25);cursor:pointer;transition:transform .15s ease, background .2s ease}
    .dot.active{background:#fff;transform:scale(1.3)}

    .caption{position:absolute;left:0;right:0;bottom:48px;text-align:center;color:#eaeaea;text-shadow:0 2px 8px rgba(0,0,0,.65);padding:4px 10px;font-size:14px}

    @media (hover:none){ .btn{background:rgba(0,0,0,.5)} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title" id="title">图片集</div>
      <div class="meta" id="meta">0 / 0</div>
    </header>

    <main class="stage" id="stage">
      <div class="stage-inner">
        <div class="layer show"><img id="imgA" class="viewer" alt="" loading="eager"></div>
        <div class="layer"><img id="imgB" class="viewer" alt="" loading="eager"></div>
      </div>
      <div class="caption" id="caption"></div>
      <div class="zoom-controls">
        <button class="zoom-btn" id="zoomIn" aria-label="放大" title="放大 (+)">+</button>
        <button class="zoom-btn" id="zoomOut" aria-label="缩小" title="缩小 (-)">−</button>
        <button class="zoom-btn" id="resetZoom" aria-label="重置缩放" title="重置缩放 (0)">↺</button>
      </div>
      <div class="controls">
        <button class="btn" id="prev" aria-label="上一张" title="上一张 (←)">⟨</button>
        <button class="btn" id="next" aria-label="下一张" title="下一张 (→)">⟩</button>
      </div>
      <div class="dots" id="dots"></div>
    </main>
  </div>

  <script>
  // ======== 配置（按需修改）========
  const CONFIG = {
    title: '图片集',           // 标题
    loop: true,               // 是否循环
    autoplay: false,          // 是否自动播放
    intervalMs: 5000,         // 自动播放间隔

    // 方式 A：使用 OSS 中的清单文件（推荐）。把 images.json 放到同目录或可访问的 URL。
    useManifest: true,
    manifestUrl: 'images.json',

    // 方式 B：直接在此处写死图片列表（字符串或 {src, caption} 对象）
    inlineImages: [
      'https://color-card-display.oss-cn-beijing.aliyuncs.com/one.png',
      'https://color-card-display.oss-cn-beijing.aliyuncs.com/two.jpg'
      // 'https://your-bucket.oss-cn-xxx.aliyuncs.com/gallery/001.jpg',
      // { src: 'https://your-bucket.oss-cn-xxx.aliyuncs.com/gallery/002.jpg', caption: '可选的说明文字' },
    ]
  };

  // ======== 逻辑实现 ========
  const $ = (s, el=document) => el.querySelector(s);
  const stage = $('#stage');
  const titleEl = $('#title');
  const metaEl = $('#meta');
  const captionEl = $('#caption');
  const dotsEl = $('#dots');
  const btnPrev = $('#prev');
  const btnNext = $('#next');
  const zoomInBtn = $('#zoomIn');
  const zoomOutBtn = $('#zoomOut');
  const resetZoomBtn = $('#resetZoom');

  const layerA = $('#imgA').closest('.layer');
  const layerB = $('#imgB').closest('.layer');
  const imgA = $('#imgA');
  const imgB = $('#imgB');

  let imgs = [];
  let index = 0;
  let activeLayer = 'A';
  let timer = null;
  
  // 缩放相关变量
  let scale = 1;
  let currentScale = 1;
  let startX, startY, startDistance;
  let isPinching = false;

  init();

  async function init(){
    document.title = CONFIG.title;
    titleEl.textContent = CONFIG.title;

    imgs = await loadImages();
    if (!imgs.length) {
      captionEl.textContent = '未配置图片。请在 CONFIG.inlineImages 中添加，或提供 images.json。';
      metaEl.textContent = '0 / 0';
      return;
    }

    buildDots();
    show(index, { immediate: true });
    bindEvents();

    if (CONFIG.autoplay) startAutoplay();
  }

  async function loadImages(){
    const queryParam = new URLSearchParams(location.search);
    const manifest = queryParam.get('manifest');
    const title = queryParam.get('title');
    if (title) { titleEl.textContent = title; document.title = title; }

    if (manifest) CONFIG.useManifest = true, CONFIG.manifestUrl = manifest;

    if (CONFIG.useManifest) {
      try {
        const res = await fetch(CONFIG.manifestUrl, { cache: 'no-store' });
        const data = await res.json();
        return normalizeList(data);
      } catch (e) {
        console.warn('加载清单失败，回退到内置列表', e);
        return normalizeList(CONFIG.inlineImages);
      }
    }
    return normalizeList(CONFIG.inlineImages);
  }

  function normalizeList(list){
    if (!Array.isArray(list)) return [];
    return list.map(item => typeof item === 'string' ? { src: item, caption: '' } : item)
               .filter(x => x && x.src);
  }

  function buildDots(){
    dotsEl.innerHTML = '';
    imgs.forEach((_, i) => {
      const d = document.createElement('button');
      d.className = 'dot' + (i===index ? ' active' : '');
      d.ariaLabel = `跳转到第 ${i+1} 张`;
      d.addEventListener('click', () => go(i));
      dotsEl.appendChild(d);
    });
  }

  function setMeta(){
    metaEl.textContent = `${index+1} / ${imgs.length}`;
    captionEl.textContent = imgs[index].caption || '';
    [...dotsEl.children].forEach((el, i) => el.classList.toggle('active', i===index));
  }

  function preload(i){
    const next = new Image();
    if (imgs[i]) next.src = imgs[i].src;
  }

  function show(i, { immediate=false }={}){
    const item = imgs[i];
    if (!item) return;

    const front = activeLayer === 'A' ? imgA : imgB; // 当前显示的 img 元素
    const back  = activeLayer === 'A' ? imgB : imgA; // 准备切换到的 img 元素
    const frontLayer = front.closest('.layer');
    const backLayer  = back.closest('.layer');

    // 设置下一张
    back.src = item.src;
    back.alt = item.caption || `第 ${i+1} 张`;

    if (immediate){
      // 初始加载不做动画
      frontLayer.classList.remove('show');
      backLayer.classList.add('show');
      activeLayer = activeLayer === 'A' ? 'B' : 'A';
    } else {
      // 交叉淡入
      requestAnimationFrame(() => {
        frontLayer.classList.remove('show');
        backLayer.classList.add('show');
        activeLayer = activeLayer === 'A' ? 'B' : 'A';
      });
    }

    setMeta();
    preload((i+1)%imgs.length);
    
    // 重置缩放
    resetZoom();
  }

  function go(i){
    if (!imgs.length) return;
    if (i < 0) i = CONFIG.loop ? (imgs.length - 1) : 0;
    if (i >= imgs.length) i = CONFIG.loop ? 0 : (imgs.length - 1);
    if (i === index) return;
    index = i;
    show(index);
  }
  const next = () => go(index+1);
  const prev = () => go(index-1);

  // 缩放功能函数
  function applyZoom(imgElement) {
    imgElement.style.transform = `scale(${currentScale})`;
  }
  
  function zoomIn() {
    currentScale *= 1.2;
    currentScale = Math.min(currentScale, 5); // 最大放大5倍
    const currentImg = activeLayer === 'A' ? imgA : imgB;
    applyZoom(currentImg);
  }
  
  function zoomOut() {
    currentScale *= 0.8;
    currentScale = Math.max(currentScale, 0.5); // 最小缩小到0.5倍
    const currentImg = activeLayer === 'A' ? imgA : imgB;
    applyZoom(currentImg);
  }
  
  function resetZoom() {
    currentScale = 1;
    const currentImg = activeLayer === 'A' ? imgA : imgB;
    applyZoom(currentImg);
  }
  
  function getDistance(touch1, touch2) {
    const dx = touch1.clientX - touch2.clientX;
    const dy = touch1.clientY - touch2.clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  function bindEvents(){
    btnNext.addEventListener('click', next);
    btnPrev.addEventListener('click', prev);
    zoomInBtn.addEventListener('click', zoomIn);
    zoomOutBtn.addEventListener('click', zoomOut);
    resetZoomBtn.addEventListener('click', resetZoom);

    // 键盘
    window.addEventListener('keydown', e => {
      if (e.key === 'ArrowRight') next();
      if (e.key === 'ArrowLeft') prev();
      if (e.key === '+' || e.key === '=') zoomIn();
      if (e.key === '-' || e.key === '_') zoomOut();
      if (e.key === '0') resetZoom();
    });

    // 鼠标滚轮缩放
    stage.addEventListener('wheel', e => {
      e.preventDefault();
      if (e.deltaY < 0) {
        zoomIn();
      } else {
        zoomOut();
      }
    }, { passive: false });

    // 触摸滑动
    let x0 = null, y0 = null, t0 = 0;
    const THRESH = 40; // 需要滑动的阈值
    
    // 双指缩放
    stage.addEventListener('touchstart', e => {
      if (e.touches.length === 2) {
        isPinching = true;
        startDistance = getDistance(e.touches[0], e.touches[1]);
        e.preventDefault();
      } else {
        const t = e.changedTouches[0];
        x0 = t.clientX; y0 = t.clientY; t0 = Date.now();
      }
    }, { passive: false });
    
    stage.addEventListener('touchmove', e => {
      if (isPinching && e.touches.length === 2) {
        const currentDistance = getDistance(e.touches[0], e.touches[1]);
        const scaleChange = currentDistance / startDistance;
        
        // 应用缩放变化
        currentScale = Math.min(Math.max(scale * scaleChange, 0.5), 5);
        const currentImg = activeLayer === 'A' ? imgA : imgB;
        applyZoom(currentImg);
        e.preventDefault();
      }
    }, { passive: false });
    
    stage.addEventListener('touchend', e => {
      if (isPinching) {
        isPinching = false;
        scale = currentScale; // 保存当前缩放级别
      } else {
        const t = e.changedTouches[0];
        const dx = t.clientX - x0; const dy = Math.abs(t.clientY - y0);
        const dt = Date.now() - t0;
        // 横向滑动，且距离足够，且耗时不是特别长
        if (Math.abs(dx) > THRESH && dy < 80 && dt < 800){
          dx < 0 ? next() : prev();
        }
      }
    }, { passive: true });

    // 防止长按选中文字/图片
    stage.addEventListener('mousedown', e => e.preventDefault());
  }

  function startAutoplay(){
    stopAutoplay();
    timer = setInterval(next, CONFIG.intervalMs);
    stage.addEventListener('pointerdown', stopAutoplay, { once: true });
  }
  function stopAutoplay(){ if (timer) clearInterval(timer), timer = null; }
  </script>
</body>
</html>